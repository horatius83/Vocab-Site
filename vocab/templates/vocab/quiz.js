var quizText = `{
    "name": ".\Italian\Italian5.json",
    "vocab": [
        {
            "answer": "ha",
            "failed": 0,
            "lastAsked": 1445533916.2659762,
            "question": "Carlo ___ due sorelle.",
            "tried": 1
        },
        {
            "answer": "nipoti",
            "failed": 0,
            "lastAsked": 1445533938.204976,
            "question": "Io ho una nipote -> Io ho due ___",
            "tried": 1
        },
        {
            "answer": "Giorgio e Pete hanno sempre sonno.",
            "failed": 1,
            "lastAsked": 1445534063.6969762,
            "question": "What is the definition of \\"Giorgio and Pete are always sleepy.\\"?",
            "tried": 2
        },
        {
            "answer": "I am always in a hurry, too.",
            "failed": 0,
            "lastAsked": 1445533934.044976,
            "question": "Given the definition \\"Anche io ho sempre fretta.\\", what is the word?",
            "tried": 1
        },
        {
            "answer": "Maria ha sempre freddo.",
            "failed": 1,
            "lastAsked": 1445534068.915976,
            "question": "What is the definition of \\"Maria is always cold.\\"?",
            "tried": 2
        },
        {
            "answer": "bambini",
            "failed": 0,
            "lastAsked": 1445533907.566976,
            "question": "Io ho un bambino -> Io ho due ___",
            "tried": 1
        },
        {
            "answer": "sorelle",
            "failed": 0,
            "lastAsked": 1445533910.385976,
            "question": "Plural of sorella",
            "tried": 1
        },
        {
            "answer": "ha",
            "failed": 0,
            "lastAsked": 1445534049.4969761,
            "question": "Marta ___ due sorelle.",
            "tried": 1
        },
        {
            "answer": "ho",
            "failed": 0,
            "lastAsked": 1445534072.2759762,
            "question": "Io ___ due sorelle.",
            "tried": 1
        },
        {
            "answer": "abbiamo",
            "failed": 0,
            "lastAsked": 1445534097.993976,
            "question": "Noi ___ due sorelle.",
            "tried": 1
        },
        {
            "answer": "madri",
            "failed": 0,
            "lastAsked": 1445534093.9339762,
            "question": "Plural of madre",
            "tried": 1
        },
        {
            "answer": "Loro hanno voglia di un caffe'.",
            "failed": 1,
            "lastAsked": 1445534182.8089762,
            "question": "What is the definition of \\"They feel like having a coffee.\\"?",
            "tried": 2
        },
        {
            "answer": "abbiamo",
            "failed": 0,
            "lastAsked": 1445534076.0159762,
            "question": "(avere) noi ->",
            "tried": 1
        },
        {
            "answer": "bambine",
            "failed": 0,
            "lastAsked": 1445534081.5749762,
            "question": "Io ho una bamina -> Io ho due ___",
            "tried": 1
        },
        {
            "answer": "avete",
            "failed": 0,
            "lastAsked": 1445534088.3749762,
            "question": "Voi ___ due sorelle.",
            "tried": 1
        },
        {
            "answer": "ragazze",
            "failed": 0,
            "lastAsked": 1445534091.534976,
            "question": "Plural of ragazza",
            "tried": 1
        },
        {
            "answer": "Betty and Rose are always in a hurry.",
            "failed": 0,
            "lastAsked": 1445534192.227976,
            "question": "Given the definition \\"Betty e Rose hanno sempre fretta.\\", what is the word?",
            "tried": 1
        },
        {
            "answer": "ragazzi",
            "failed": 0,
            "lastAsked": 1445534215.5069761,
            "question": "Plural of ragazzo",
            "tried": 1
        },
        {
            "answer": "fan",
            "failed": 0,
            "lastAsked": 1445534294.3609762,
            "question": "What is the definition of \\"ventilatore\\"?",
            "tried": 1
        },
        {
            "answer": "studenti",
            "failed": 0,
            "lastAsked": 1445534298.4009762,
            "question": "Plural of studente",
            "tried": 1
        },
        {
            "answer": "Lei ha bisogno di una sciarpa.",
            "failed": 1,
            "lastAsked": 1445534320.9999762,
            "question": "What is the definition of \\"She needs a scarf.\\"?",
            "tried": 2
        },
        {
            "answer": "ha",
            "failed": 0,
            "lastAsked": 1445534302.6409762,
            "question": "Lei ___ due sorelle.",
            "tried": 1
        },
        {
            "answer": "There are three boys and five girls.",
            "failed": 0,
            "lastAsked": 1445534212.2469761,
            "question": "Given the definition \\"Ci sono quattro ragazzi e cinque ragazze.\\", what is the word?",
            "tried": 1
        },
        {
            "answer": "friends",
            "failed": 1,
            "lastAsked": 1445534305.1809762,
            "question": "What is the definition of \\"amici\\"?",
            "tried": 2
        },
        {
            "answer": "Noi abbiamo bisogno di un ventilatore.",
            "failed": 0,
            "lastAsked": 1445534340.517976,
            "question": "Given the definition \\"We need a fan.\\", what is the word?",
            "tried": 1
        },
        {
            "answer": "studentessa",
            "failed": 0,
            "lastAsked": 1445534354.876976,
            "question": "Given the definition \\"female student\\", what is the word?",
            "tried": 1
        },
        {
            "answer": "Maria is always cold.",
            "failed": 0,
            "lastAsked": 1445534361.516976,
            "question": "Given the definition \\"Maria ha sempre freddo.\\", what is the word?",
            "tried": 1
        },
        {
            "answer": "figli",
            "failed": 0,
            "lastAsked": 1445534346.977976,
            "question": "Io ho un figlio -> Io ho due ___",
            "tried": 1
        },
        {
            "answer": "She needs a scarf.",
            "failed": 0,
            "lastAsked": 1445534326.238976,
            "question": "Given the definition \\"Lei ha bisogno di una sciarpa.\\", what is the word?",
            "tried": 1
        },
        {
            "answer": "female student",
            "failed": 0,
            "lastAsked": 1445534351.017976,
            "question": "What is the definition of \\"studentessa\\"?",
            "tried": 1
        },
        {
            "answer": "padri",
            "failed": 0,
            "lastAsked": 1445534363.9969761,
            "question": "Plural of padre",
            "tried": 1
        },
        {
            "answer": "studente",
            "failed": 0,
            "lastAsked": 1445534370.3359761,
            "question": "Given the definition \\"male student\\", what is the word?",
            "tried": 1
        },
        {
            "answer": "avere bisogno di",
            "failed": 0,
            "lastAsked": 1445534436.231976,
            "question": "Given the definition \\"to need\\", what is the word?",
            "tried": 1
        },
        {
            "answer": "sciarpa",
            "failed": 0,
            "lastAsked": 1445534428.531976,
            "question": "Given the definition \\"scarf\\", what is the word?",
            "tried": 1
        },
        {
            "answer": "panino",
            "failed": 1,
            "lastAsked": 1445534456.970976,
            "question": "Given the definition \\"sandwich\\", what is the word?",
            "tried": 2
        },
        {
            "answer": "ha",
            "failed": 0,
            "lastAsked": 1445534416.7729762,
            "question": "Lui ___ due sorelle.",
            "tried": 1
        },
        {
            "answer": "hanno",
            "failed": 0,
            "lastAsked": 1445534420.192976,
            "question": "(avere) loro ->",
            "tried": 1
        },
        {
            "answer": "Betty e Rose hanno sempre fretta.",
            "failed": 0,
            "lastAsked": 1445534401.753976,
            "question": "What is the definition of \\"Betty and Rose are always in a hurry.\\"?",
            "tried": 1
        },
        {
            "answer": "avere voglia di",
            "failed": 1,
            "lastAsked": 1445534454.3909762,
            "question": "Given the definition \\"to feel like something\\", what is the word?",
            "tried": 2
        },
        {
            "answer": "male friend",
            "failed": 0,
            "lastAsked": 1445534424.9929762,
            "question": "What is the definition of \\"amico\\"?",
            "tried": 1
        },
        {
            "answer": "hai",
            "failed": 0,
            "lastAsked": 1445534524.4859762,
            "question": "Tu ___ due sorelle.",
            "tried": 1
        },
        {
            "answer": "Here are my friends.",
            "failed": 1,
            "lastAsked": 1445534539.524976,
            "question": "Given the definition \\"Ecco i miei amici.\\", what is the word?",
            "tried": 2
        },
        {
            "answer": "hai",
            "failed": 0,
            "lastAsked": 1445534474.668976,
            "question": "(avere) tu ->",
            "tried": 1
        },
        {
            "answer": "fratelli",
            "failed": 0,
            "lastAsked": 1445534460.889976,
            "question": "Plural of fratello",
            "tried": 1
        },
        {
            "answer": "They feel like having a coffee.",
            "failed": 1,
            "lastAsked": 1445534554.6839762,
            "question": "Given the definition \\"Loro hanno voglia di un caffe'.\\", what is the word?",
            "tried": 2
        },
        {
            "answer": "to need",
            "failed": 0,
            "lastAsked": 1445534502.807976,
            "question": "What is the definition of \\"avere bisogno di\\"?",
            "tried": 1
        },
        {
            "answer": "Matteo is always hungry.",
            "failed": 0,
            "lastAsked": 1445534521.105976,
            "question": "Given the definition \\"Metteo ha sempre fame.\\", what is the word?",
            "tried": 1
        },
        {
            "answer": "studentesse",
            "failed": 1,
            "lastAsked": 1445534545.0649762,
            "question": "Plural of studentessa",
            "tried": 2
        },
        {
            "answer": "We need a fan.",
            "failed": 0,
            "lastAsked": 1445534605.100976,
            "question": "What is the definition of \\"Noi abbiamo bisogno di un ventilatore.\\"?",
            "tried": 1
        },
        {
            "answer": "avete",
            "failed": 0,
            "lastAsked": 1445534558.1639762,
            "question": "(avere) voi ->",
            "tried": 1
        },
        {
            "answer": "Metteo ha sempre fame.",
            "failed": 0,
            "lastAsked": 1445534582.521976,
            "question": "What is the definition of \\"Matteo is always hungry.\\"?",
            "tried": 1
        },
        {
            "answer": "ho",
            "failed": 0,
            "lastAsked": 1445534609.6409762,
            "question": "(avere) io ->",
            "tried": 1
        },
        {
            "answer": "sandwich",
            "failed": 0,
            "lastAsked": 1445534613.159976,
            "question": "What is the definition of \\"panino\\"?",
            "tried": 1
        },
        {
            "answer": "Lui ha voglia di un panino.",
            "failed": 0,
            "lastAsked": 1445534596.3609762,
            "question": "What is the definition of \\"He feels like having a sandwich.\\"?",
            "tried": 1
        },
        {
            "answer": "Kate and I are always hot.",
            "failed": 0,
            "lastAsked": 1445534569.182976,
            "question": "Given the definition \\"Io e Kate abbiamo sempre caldo.\\", what is the word?",
            "tried": 1
        },
        {
            "answer": "hanno",
            "failed": 0,
            "lastAsked": 1445534585.5619762,
            "question": "Loro ___ due sorelle.",
            "tried": 1
        },
        {
            "answer": "caffe'",
            "failed": 0,
            "lastAsked": 1445534688.5949762,
            "question": "Given the definition \\"coffee\\", what is the word?",
            "tried": 1
        },
        {
            "answer": "coffee",
            "failed": 0,
            "lastAsked": 1445534691.174976,
            "question": "What is the definition of \\"caffe'\\"?",
            "tried": 1
        },
        {
            "answer": "to feel like something",
            "failed": 0,
            "lastAsked": 1445534686.195976,
            "question": "What is the definition of \\"avere voglia di\\"?",
            "tried": 1
        },
        {
            "answer": "scarf",
            "failed": 0,
            "lastAsked": 1445534618.7799761,
            "question": "What is the definition of \\"sciarpa\\"?",
            "tried": 1
        },
        {
            "answer": "Anche io ho sempre fretta.",
            "failed": 0,
            "lastAsked": 1445534648.8579762,
            "question": "What is the definition of \\"I am always in a hurry, too.\\"?",
            "tried": 1
        },
        {
            "answer": "amica",
            "failed": 0,
            "lastAsked": 1445534616.139976,
            "question": "Given the definition \\"female friend\\", what is the word?",
            "tried": 1
        },
        {
            "answer": "He feels like having a sandwich.",
            "failed": 0,
            "lastAsked": 1445534631.7789762,
            "question": "Given the definition \\"Lui ha voglia di un panino.\\", what is the word?",
            "tried": 1
        },
        {
            "answer": "Ecco i miei amici.",
            "failed": 1,
            "lastAsked": 1445534698.494976,
            "question": "What is the definition of \\"Here are my friends.\\"?",
            "tried": 2
        },
        {
            "answer": "nonne",
            "failed": 0,
            "lastAsked": 1445534703.4139762,
            "question": "Io ho una nonna -> Io ho due ___",
            "tried": 1
        },
        {
            "answer": "male student",
            "failed": 0,
            "lastAsked": 1445534724.932976,
            "question": "What is the definition of \\"studente\\"?",
            "tried": 1
        },
        {
            "answer": "female friend",
            "failed": 0,
            "lastAsked": 1445534745.751976,
            "question": "What is the definition of \\"amica\\"?",
            "tried": 1
        },
        {
            "answer": "ventilatore",
            "failed": 0,
            "lastAsked": 1445534708.1939762,
            "question": "Given the definition \\"fan\\", what is the word?",
            "tried": 1
        },
        {
            "answer": "amici",
            "failed": 0,
            "lastAsked": 1445534727.932976,
            "question": "Given the definition \\"friends\\", what is the word?",
            "tried": 1
        },
        {
            "answer": "Giorgio and Pete are always sleepy.",
            "failed": 0,
            "lastAsked": 1445534741.431976,
            "question": "Given the definition \\"Giorgio e Pete hanno sempre sonno.\\", what is the word?",
            "tried": 1
        },
        {
            "answer": "zie",
            "failed": 0,
            "lastAsked": 1445534713.793976,
            "question": "Io ho una zia -> Io ho due ___",
            "tried": 1
        },
        {
            "answer": "sorelle",
            "failed": 0,
            "lastAsked": 1445534731.072976,
            "question": "Io ho una sorella -> Io ho due ___",
            "tried": 1
        },
        {
            "answer": "Io e Kate abbiamo sempre caldo.",
            "failed": 0,
            "lastAsked": 1445534806.507976,
            "question": "What is the definition of \\"Kate and I are always hot.\\"?",
            "tried": 1
        },
        {
            "answer": "amico",
            "failed": 0,
            "lastAsked": 1445534779.3489761,
            "question": "Given the definition \\"male friend\\", what is the word?",
            "tried": 1
        },
        {
            "answer": "Ci sono quattro ragazzi e cinque ragazze.",
            "failed": 0,
            "lastAsked": 1445534764.829976,
            "question": "What is the definition of \\"There are three boys and five girls.\\"?",
            "tried": 1
        },
        {
            "answer": "ha",
            "failed": 0,
            "lastAsked": 1445534808.507976,
            "question": "(avere) lui/lei/Lei ->",
            "tried": 1
        },
        {
            "answer": "cugine",
            "failed": 0,
            "lastAsked": 1445534775.669976,
            "question": "Io ho una cugina -> Io ho due ___",
            "tried": 1
        }
    ]
}`;
var quizJson = JSON.parse(quizText);

var Utility = {
    /**
     * Split a list into sections of a given length
     *
     * @method splitIntoSections
     * @param lst {List} a list of elements
     * @param lengthOfSection {Int} the length of each section
     * @return {List} a list of lists of the requested length
     */
    splitIntoSections : function(lst, lengthOfSection) {
        // given a list, split it into sub-lists of a given length
        var returnList = [];
        for(var i=0;i<lst.length;i+=lengthOfSection) {
            returnList.push(lst.slice(i,i+lengthOfSection));
        }
        return returnList;
    },
    /**
     * Use the Duestenfeld shuffle to randomize a list
     *
     * @method shuffle 
     * @param arry {List} a list to be shuffled
     * @return {List} a shuffled list
     */
    shuffle : function(arry) {
        var rv = arry.slice(0,arry.length);
        for(var i=rv.length-1;i>0;i--) {
            var j = Math.floor(Math.random() * (i+1));
            var temp = rv[i];
            rv[i] = rv[j];
            rv[j] = temp;
        }
        return rv;
    },
    range : function(begin, end, step) {
            if(step === undefined) {
                step = 1;
            }
            var rv = [];
            if(step > 0) {
                for(var i=begin;i<=end;i+=step) {
                    rv.push(i);
                }
            } else if(step < 0) {
                for(var i=begin;i>=end;i+=step) {
                    rv.push(i);
                }
            }
            return rv;
    },
    repeat : function(times, value) {
        var rv = [];
        if(times < 0) {
            return [];
        }
        for(var i=0;i<times;i++) {
            rv.push(value);
        }
        return rv;
    },
    findFirstOf : function(lst, predicate) {
        for(var i=0;i<lst.length;i++) {
            if(predicate(lst[i])) {
                return [true, lst[i]];
            }
        }
        return [false, undefined];
    },
    findFirstWithIndex : function(lst, predicate) {
        for(var i=0;i<lst.length;i++) {
            if(predicate(i,lst[i])) {
                return [true, i, lst[i]];
            }
        }
        return [false, undefined, undefined];
    },
    makeRing : function(lst,index) {
        return lst.slice(index+1,lst.length).concat(lst.slice(0,index));
    }
};

function createQuiz() {
    var u = Utility;
    /**
     * Get the current question node including question, answer
     * and stats
     *
     * @method getCurrentQuestion
     * @return {Object} an object containing the question, the answer and
     * any relevent stats
     */
    this.getCurrentQuestion = function() {
        var index = this.indices[this.section.index][this.section.questionIndex].index;
        return this.questions[index];
    };
    /**
     * Go to the next question, if we're reviewing then go to the next question
     * that was wrong the last time through
     * @method gotoNextQuestion
     */
    this.gotoNextQuestion = function() {
        // Clear the answer
        this.clearUserAnswer();
        // If we're going to the next question, we're no longer reviewing
        this.state.isReviewing = false;
                    
        // Get the next question
        var currentIndex = this.section.questionIndex;
        // Search in the remaining list
        var isFalse = function(x) { return !x; };
        // Search for the first wrong answer
        var nextQuestion = u.findFirstOf(this.indices[this.section.index].slice(this.section.questionIndex+1), isFalse);
        if(!nextQuestion[0]) { // go back to the beginning of the list
            this.indices[this.section.index] = u.shuffle(this.indices[this.section.index]); // shuffle the list
            nextQuestion = u.findFirstOf(this.indices[this.section.index], isFalse); // find the first wrong answer
        }
        if(nextQuestion[0]) {
            this.section.questionIndex = nextQuestion[1]; // The next question is the next wrong answer
        } else { // There are no more false questions in this section
            this.section.index += 1;
            this.section.questionIndex = 0;
        }
    };
    /**
     * Get the number of times this question has been attempted
     * vs. the number of times the answer was incorrect
     * @method getAverage
     */
    this.getAverage = function() {
        var question = this.getCurrentQuestion();
        var tried = question['tried'];
        var failed = question['failed'];
        return failed / tried;
    };
    this.getUserAnswer = function() {
        var userAnswer = document.querySelector('#answer').value;
        return userAnswer;
    };
    this.clearUserAnswer = function() {
        var userAnswerTextField = document.querySelector('#answer');
        userAnswerTextField.value = '';
        userAnswerTextField.focus();
    };
    this.checkAnswer = function() {
        var actualAnswer = this.getCurrentQuestion()['answer'];
        var userAnswer = this.getUserAnswer();
        var question = this.getCurrentQuestion()['question'];
        question['tried'] += 1;
        question['lastTried'] = new Date().getTime();

        if(actualAnswer === userAnswer) {
            this.gotoNextQuestion();
        } else {
            this.state.isAsking = false;
            this.state.isChecking = true;
        }
    };
    this.answerWas = function(wasTrue) { 
        if(wasTrue) {
            this.gotoNextQuestion();
            this.state.isAsking = true;
            this.state.isChecking = false;
        } else {
            this.state.isAsking = true;
            this.state.isChecking = false;
            this.state.isReviewing = true;
            this.clearUserAnswer();
        }
    };
    this.section = {
        'index': 0, 
        'questionIndex': 0, 
        'size': 8, 
        'allCorrect': function() {
            for(var i=0;i<this.indices[this.section.index].length;i++) {
                if(this.indices[this.section.index][i].result == false) {
                    return false;
                }
            }
            return true;
        }, 
    };
    this.state = {'isAsking': true, 'isChecking': false, 'isReviewing' : false};
    this.title = quizJson['name'];
    this.questions = quizJson['vocab'];
    this.indices = u.splitIntoSections(u.shuffle(u.range(0,quizJson['vocab'].length)),this.section.size)
        .map(function(lst) { 
            return lst.map(function(x) { 
                return { 'index' : x, 'result' : false}})});
    this.questions.current = this.getCurrentQuestion()['question'];
}

(function(){
    var quizApp = angular.module('quizApp', []);
    quizApp.controller('QuizController', createQuiz);
})();
